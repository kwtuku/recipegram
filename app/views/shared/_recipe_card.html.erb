<div class="column <%= recipes_show? ? 'is-7' : 'is-4' %>">
  <div class="card">
    <% if controller.controller_name == "recipes" && controller.action_name == "show" %>
      <div class="card-header">
        <p class="card-header-title">
          <span class="icon-text">
            <span class="icon">
              <i class="fas fa-home"></i>
            </span>
            <span><%= link_to recipe.user.username, user_path(recipe.user),class: "has-text-black-bis" %></span>
          </span>
        </p>
        <div class="dropdown is-right card-header-icon">
          <div class="dropdown-trigger">
            <button class="button is-white is-small" aria-haspopup="true" aria-controls="dropdown-menu">
              <span class="icon is-small">
                <i class="fa fa-ellipsis-h" aria-hidden="true"></i>
              </span>
            </button>
          </div>
          <div class="dropdown-menu" id="dropdown-menu" role="menu">
            <div class="dropdown-content">
              <% if user_signed_in? && recipe.user.id == current_user.id %>
                <%= link_to "編集する", edit_recipe_path(recipe), class: "dropdown-item" %>
                <%= link_to "削除する", recipe_path(recipe), method: :delete, data: {confirm: "削除しますか？"}, class: "dropdown-item" %>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    <% end %>

    <div class="card-image">
      <figure class="image is-4by3" id="recipe-image">
        <% if controller.controller_name == "recipes" && controller.action_name == "show" %>
          <%= image_tag recipe.recipe_image.url %>
        <% else %>
          <%= link_to recipe_path(recipe) do %>
            <%= image_tag recipe.recipe_image.url %>
            <div class="mask has-text-centered">
              <p class="has-text-white">
                <span class="icon-text mr-3">
                  <span class="icon">
                    <i class="far fa-heart"></i>
                  </span>
                  <span><%= recipe.favorites.size %></span>
                </span>
                <span class="icon-text">
                  <span class="icon">
                    <i class="far fa-comment"></i>
                  </span>
                  <span><%= recipe.comments.size %></span>
                </span>
              </p>
            </div>
          <% end %>
        <% end %>
      </figure>
    </div>

    <% if controller.controller_name == "recipes" && controller.action_name == "show" %>
      <div class="card-content">
        <p class="title is-3"><%= link_to_unless_current recipe.title, recipe_path(recipe) %></p>
        <div class="level is-mobile">
          <div class="level-item has-text-centered">
            <div>
              <p class="title">
                <%= render 'shared/favorite_button', recipe: recipe %>
              </p>
            </div>
          </div>
          <div class="level-item has-text-centered">
            <div>
              <a href="#comments">
                <span class="icon-text has-text-primary">
                  <span class="icon">
                    <i class="far fa-comment"></i>
                  </span>
                  <span><%= recipe.comments.size %></span>
                </span>
              </a>
            </div>
          </div>
          <div class="level-item has-text-centered">
            <div>
              <p class="heading">投稿日</p>
              <p class="title is-6"><%= l recipe.created_at, format: :ymd %></p>
            </div>
          </div>
          <div class="level-item has-text-centered">
            <div>
              <p class="heading">更新日</p>
              <p class="title is-6"><%= l recipe.updated_at, format: :ymd %></p>
            </div>
          </div>
        </div>
        <p class="subtitle">レシピ</p>
        <p><%= simple_format h(recipe.body) %></p>
      </div>

      <div class="card-content">
        <p class="subtitle" id="comments">コメント一覧</p>
        <div class="oldest-comment">
          <% if recipe.comments.length > 0 %>
            <div class="media mb-5">
              <figure class="media-left">
                <p class="image is-64x64">
                  <%= link_to user_path(recipe.comments.first.user) do %>
                    <%= image_tag recipe.comments.first.user.user_image.url, class: "is-rounded" %>
                  <% end %>
                </p>
              </figure>
              <div class="media-content">
                <p class="title is-5"><%= link_to recipe.comments.first.user.username, user_path(recipe.comments.first.user), class: "has-text-black-bis" %></p>
                <p><%= simple_format h(recipe.comments.first.body) %></p>
                <time class="has-text-grey-light" datetime="<%= recipe.comments.first.created_at %>"><%= time_ago_in_words(recipe.comments.first.created_at) %>前</time>
              </div>
              <div class="media-right">
                <div class="dropdown is-right">
                  <div class="dropdown-trigger">
                    <button class="button is-white is-small" aria-haspopup="true" aria-controls="dropdown-menu">
                      <span class="icon is-small">
                        <i class="fa fa-ellipsis-h "></i>
                      </span>
                    </button>
                  </div>
                  <div class="dropdown-menu" id="dropdown-menu" role="menu">
                    <div class="dropdown-content">
                      <% if current_user.id == recipe.comments.first.user_id %>
                        <%= link_to "削除する", recipe_comment_path(recipe.comments.first), method: :delete, data: {confirm: "削除しますか？"}, class: "dropdown-item" %>
                      <% end %>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <% if recipe.comments.length > 1 %>
              <div class="has-text-centered mb-5" id="readmore"><div class="button is-rounded">もっと見る</div></div>
            <% end %>
          <% end %>
        </div>
        <div class="all-comments is-hidden">
          <% recipe.comments.find_each do |comment| %>
            <div class="media">
              <figure class="media-left">
                <p class="image is-64x64">
                  <%= link_to user_path(comment.user) do %>
                    <%= image_tag comment.user.user_image.url, class: "is-rounded" %>
                  <% end %>
                </p>
              </figure>
              <div class="media-content">
                <p class="title is-5"><%= link_to comment.user.username, user_path(comment.user), class: "has-text-black-bis" %></p>
                <p><%= simple_format h(comment.body) %></p>
                <time class="has-text-grey-light" datetime="<%= comment.created_at %>"><%= time_ago_in_words(comment.created_at) %>前</time>
              </div>
              <div class="media-right">
                <div class="dropdown is-right">
                  <div class="dropdown-trigger">
                    <button class="button is-white is-small" aria-haspopup="true" aria-controls="dropdown-menu">
                      <span class="icon is-small">
                        <i class="fa fa-ellipsis-h "></i>
                      </span>
                    </button>
                  </div>
                  <div class="dropdown-menu" id="dropdown-menu" role="menu">
                    <div class="dropdown-content">
                      <% if current_user.id == comment.user_id %>
                        <%= link_to "削除する", recipe_comment_path(comment), method: :delete, data: {confirm: "削除しますか？"}, class: "dropdown-item" %>
                      <% end %>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
          <div class="has-text-centered mb-5" id="readless"><div class="button is-rounded">閉じる</div></div>
        </div>
        <div class="content">
          <%= form_with model: [recipe, @comment] do |f| %>
            <div class="field">
              <%= f.text_area :body, :placeholder => "コメントを追加", required: true, class: "input" %>
            </div>
            <%= f.submit "コメントを投稿", class: "button is-primary is-rounded" %>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
</div>

<% if controller.controller_name == "recipes" && controller.action_name == "show" %>
  <div class="modal">
    <div class="modal-background"></div>
    <div class="modal-content">
      <p class="image is-4by3">
        <%= image_tag recipe.recipe_image.url %>
      </p>
    </div>
    <button class="modal-close is-large" aria-label="close"></button>
  </div>
<% end %>
